<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Tomato House | Visitor Hub</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #5C5E3B;
            color: #f7f7f7;
        }
        .message-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 2rem;
            background-color: #f7f7f7;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 1000;
        }
        .message-box-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        /* New CSS for button hover effects */
        .btn-animate {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .btn-animate:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* New CSS for fade-in animation on list items */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Accessible Message Box -->
    <div id="message-box" class="message-box max-w-sm w-full" role="alertdialog" aria-modal="true" aria-hidden="true" aria-labelledby="message-text">
        <p id="message-text" class="text-center font-semibold text-lg text-[#5C5E3B]"></p>
        <button id="message-box-close-btn" onclick="hideMessageBox()" class="mt-4 w-full px-4 py-2 bg-[#5C5E3B] text-white rounded-md hover:bg-[#4a4c2e] transition-colors">Close</button>
    </div>
    <div id="message-box-overlay" class="message-box-overlay" onclick="hideMessageBox()"></div>

    <div class="max-w-4xl mx-auto space-y-12">
        <header class="text-center mb-12">
            <div class="flex flex-col items-center mx-auto">
                <!-- The main exhibition title -->
                <h1 class="text-4xl md:text-5xl font-extrabold text-[#f7f7f7] tracking-tight mt-4">The Tomato House</h1>
                <!-- The subtitle explaining the page's purpose -->
                <p class="mt-2 text-2xl text-gray-300">Visitor Feedback Hub</p>
            </div>
        </header>

        <!-- General Feedback Section -->
        <section class="bg-[#f7f7f7] rounded-2xl p-6 md:p-8 shadow-xl">
            <h2 class="text-2xl font-bold text-[#5C5E3B] mb-4">Tell us what you thought!</h2>
            <p class="text-gray-600 mb-6">
                Your insights will help us grow! We'd love to hear what you enjoyed most and what brilliant ideas you have for our future events and exhibitions.
            </p>
            <form id="feedback-form" class="space-y-4">
                <div>
                    <label for="feedback" class="block text-sm font-medium text-gray-700">Share your feedback</label>
                    <textarea id="feedback" name="feedback" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#5C5E3B] focus:ring-[#5C5E3B] text-[#5C5E3B]"></textarea>
                </div>
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Your name (optional)</label>
                    <input type="text" id="name" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#5C5E3B] focus:ring-[#5C5E3B] text-[#5C5E3B]">
                </div>
                <button type="submit" class="w-full px-6 py-3 bg-[#5C5E3B] text-white font-semibold rounded-full shadow-lg hover:bg-[#4a4c2e] transition-colors btn-animate">Submit Feedback</button>
            </form>
            <p class="mt-4 text-xs text-gray-500 text-center">Your data is important to us. We will only use this information to help us improve future exhibitions. For more details, please see our <a href="#" class="text-[#5C5E3B] hover:underline">Privacy Policy</a>.</p>
        </section>

        <!-- Guess the Tomatoes Competition -->
        <section class="bg-[#f7f7f7] rounded-2xl p-6 md:p-8 shadow-xl">
            <h2 class="text-2xl font-bold text-[#5C5E3B] mb-4">Guess the Tomatoes!</h2>
            <p class="text-gray-600 mb-6">
                How many tomatoes are in the mini greenhouse? Take a guess! The person with the closest guess wins an Heirloom Tomato Kit.
            </p>
            <form id="guess-form" class="space-y-4">
                <div>
                    <label for="guess" class="block text-sm font-medium text-gray-700">Your Guess</label>
                    <input type="number" id="guess" name="guess" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#5C5E3B] focus:ring-[#5C5E3B] text-[#5C5E3B]" placeholder="Enter your number">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="email" name="email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#5C5E3B] focus:ring-[#5C5E3B] text-[#5C5E3B]" placeholder="your@email.com">
                </div>
                <div class="flex items-center">
                    <input id="contact-consent" name="contact-consent" type="checkbox" class="h-4 w-4 text-[#5C5E3B] rounded border-gray-300 focus:ring-[#5C5E3B]">
                    <label for="contact-consent" class="ml-2 block text-sm text-gray-700">I would like to receive updates from Heartseedling.</label>
                </div>
                <button type="submit" class="w-full px-6 py-3 bg-[#5C5E3B] text-white font-semibold rounded-full shadow-lg hover:bg-[#4a4c2e] transition-colors btn-animate">Submit Guess</button>
            </form>
            
            <div class="mt-8">
                <h3 class="text-xl font-semibold text-[#5C5E3B] mb-2">Recent Guesses</h3>
                <ul id="guess-list" class="list-disc list-inside space-y-2 text-gray-600">
                    <li class="text-center text-gray-500">No guesses yet. Be the first!</li>
                </ul>
            </div>
        </section>

        <!-- Interview Nomination -->
        <section class="bg-[#f7f7f7] rounded-2xl p-6 md:p-8 shadow-xl">
            <h2 class="text-2xl font-bold text-[#5C5E3B] mb-4">Share Your Story!</h2>
            <p class="text-gray-600 mb-6">
                Every connection to growing food, from a childhood memory to your own experiences of putting your hands in soil holds a story. We'd love to hear your personal tale in a short, relaxed chat. Your experience could become a part of our living story archive and feature in future events, helping to connect and inspire others.
            </p>
            <form id="interview-form" class="space-y-4">
                <div>
                    <label for="interview-name" class="block text-sm font-medium text-gray-700">Your Name</label>
                    <input type="text" id="interview-name" name="interview-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#5C5E3B] focus:ring-[#5C5E3B] text-[#5C5E3B]">
                </div>
                <div>
                    <label for="interview-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="interview-email" name="interview-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#5C5E3B] focus:ring-[#5C5E3B] text-[#5C5E3B]">
                </div>
                <button type="submit" class="w-full px-6 py-3 bg-[#5C5E3B] text-white font-semibold rounded-full shadow-lg hover:bg-[#4a4c2e] transition-colors btn-animate">I'm Happy to Share</button>
            </form>
        </section>

        <!-- New: Exhibition Story Section -->
        <section class="bg-[#f7f7f7] rounded-2xl p-6 md:p-8 shadow-xl">
            <h2 class="text-2xl font-bold text-[#5C5E3B] mb-4">The Heartseedling Story</h2>
            <div class="md:flex md:space-x-8 items-stretch">
                <div class="md:w-1/2">
                    <p class="text-gray-600 mb-4">
                        For our founder, the desire to grow food was ignited by a simple, powerful memory: the scent of tomato vines transporting her back to her grandad's greenhouse on a warm summer day. That visceral link to the past, alongside a desire to reduce food miles and grow her own pasta sauce, sparked the idea for Heartseedling.
                    </p>
                    <p class="text-gray-600 mb-6">
                        This endeavour is all about exploring these deep, personal connections to nature, heritage and ourselves. Itâ€™s a multi-sensory journey that helps us unearth and share the many diverse reasons why we put our hands in soil, to inspire others through creative storytelling and experiences.
                    </p>
                </div>
                <div class="md:w-1/2 flex items-center justify-center rounded-2xl shadow-lg bg-[#5C5E3B]">
                    <!-- This SVG creates the dark green box with the word 'Heartseedling' -->
                    <svg width="100%" height="100%" viewBox="0 0 400 200" xmlns="http://www.w3.org/2000/svg">
                        <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Montserrat, sans-serif" font-size="24" font-weight="400" fill="#f7f7f7">Heartseedling</text>
                    </svg>
                </div>
            </div>
        </section>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Initialization
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Enable Firestore debug logging
        setLogLevel('Debug');

        let userId = null;
        let isAuthReady = false;
        let lastFocusedElement = null;
        
        // Function to show the custom message box
        function showMessageBox(message) {
            lastFocusedElement = document.activeElement;
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            const messageOverlay = document.getElementById('message-box-overlay');
            messageText.textContent = message;
            messageBox.style.display = 'block';
            messageBox.setAttribute('aria-hidden', 'false');
            messageOverlay.style.display = 'block';
            
            // Set focus to the close button for accessibility
            document.getElementById('message-box-close-btn').focus();
        }

        // Function to hide the custom message box
        function hideMessageBox() {
            const messageBox = document.getElementById('message-box');
            const messageOverlay = document.getElementById('message-box-overlay');
            messageBox.style.display = 'none';
            messageBox.setAttribute('aria-hidden', 'true');
            messageOverlay.style.display = 'none';

            // Return focus to the last element that was focused
            if (lastFocusedElement) {
                lastFocusedElement.focus();
                lastFocusedElement = null;
            }
        }

        // Authentication and Firestore Setup
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is already signed in.
                userId = user.uid;
                console.log("Existing user signed in:", userId);
            } else {
                // No user is signed in, use the provided token or sign in anonymously.
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                    userId = auth.currentUser.uid;
                } catch (error) {
                    console.error("Authentication failed:", error);
                    showMessageBox("Authentication failed. Please check your connection.");
                    return;
                }
            }
            isAuthReady = true;
            console.log("Authentication state changed. User ID:", userId);

            if (isAuthReady) {
                setupRealtimeGuessListener();
            }
        });

        // Event listener for the General Feedback Form
        document.getElementById('feedback-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                showMessageBox("Please wait, connecting to the database...");
                return;
            }

            const feedback = document.getElementById('feedback').value;
            const name = document.getElementById('name').value;

            if (!feedback.trim()) {
                showMessageBox("Please enter your feedback before submitting.");
                return;
            }

            try {
                // Save feedback to a public collection
                const feedbackCollectionRef = collection(db, `artifacts/${appId}/public/data/exhibition-feedback`);
                await addDoc(feedbackCollectionRef, {
                    name: name || "Anonymous",
                    feedback: feedback,
                    timestamp: new Date()
                });
                showMessageBox("Thank you for your feedback! It has been submitted.");
                e.target.reset();
            } catch (error) {
                console.error("Error submitting feedback:", error);
                showMessageBox("There was an error submitting your feedback. Please try again.");
            }
        });

        // Event listener for the Guessing Game Form
        document.getElementById('guess-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                showMessageBox("Please wait, connecting to the database...");
                return;
            }

            const guess = document.getElementById('guess').value;
            const email = document.getElementById('email').value;
            const consent = document.getElementById('contact-consent').checked;

            try {
                // Save guess data to a public collection
                const guessCollectionRef = collection(db, `artifacts/${appId}/public/data/tomato-guesses`);
                await addDoc(guessCollectionRef, {
                    userId: userId,
                    guess: parseInt(guess, 10),
                    email: email,
                    contactConsent: consent,
                    timestamp: new Date()
                });
                showMessageBox("Your guess has been recorded! Good luck!");
                e.target.reset();
            } catch (error) {
                console.error("Error submitting guess:", error);
                showMessageBox("There was an error submitting your guess. Please try again.");
            }
        });

        // Event listener for the Interview Nomination Form
        document.getElementById('interview-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                showMessageBox("Please wait, connecting to the database...");
                return;
            }

            const name = document.getElementById('interview-name').value;
            const email = document.getElementById('interview-email').value;

            try {
                // Save nomination to a private collection
                const nominationCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/interview-nominations`);
                await addDoc(nominationCollectionRef, {
                    name: name,
                    email: email,
                    timestamp: new Date()
                });
                showMessageBox("Thank you for your interest! We'll be in touch.");
                e.target.reset();
            } catch (error) {
                console.error("Error submitting nomination:", error);
                showMessageBox("There was an error submitting your nomination. Please try again.");
            }
        });
        
        // Function to set up a real-time listener for the tomato guesses
        function setupRealtimeGuessListener() {
            const guessList = document.getElementById('guess-list');
            const q = query(collection(db, `artifacts/${appId}/public/data/tomato-guesses`));
            
            onSnapshot(q, (querySnapshot) => {
                const guesses = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    guesses.push({ id: doc.id, ...data });
                });

                // Sort guesses by timestamp in descending order and show the top 5
                guesses.sort((a, b) => b.timestamp - a.timestamp);
                const recentGuesses = guesses.slice(0, 5);
                
                guessList.innerHTML = '';
                if (recentGuesses.length > 0) {
                    recentGuesses.forEach(guess => {
                        const li = document.createElement('li');
                        li.textContent = `Someone guessed: ${guess.guess}`;
                        li.classList.add('text-[#5C5E3B]'); // Ensure text color is right on the light background
                        li.classList.add('fade-in'); // Add fade-in animation
                        guessList.appendChild(li);
                    });
                } else {
                    guessList.innerHTML = '<li class="text-center text-gray-500">No guesses yet. Be the first!</li>';
                }
            }, (error) => {
                console.error("Error listening to guesses:", error);
                guessList.innerHTML = '<li class="text-center text-red-500">Error loading guesses.</li>';
            });
        }

    </script>
</body>
</html>
